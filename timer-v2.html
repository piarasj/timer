<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Session Timer</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="description" content="Visual analog clock timer with URL schemes and calendar export" />
  <meta name="keywords" content="timer,pomodoro,focus,productivity,analog,clock" />
  
  <!-- PWA Meta Tags -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="SessionTimer" />
  <meta name="theme-color" content="#000000" />
  
  <!-- Icons -->
  <link rel="apple-touch-icon" href="icon-192.png" />
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png" />
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json" />
  
  <style>
    :root { color-scheme: dark; }
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background: #000;
    }
    body {
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
      font-family: -apple-system, system-ui, Segoe UI, Roboto, sans-serif;
      color: #aaa;
    }
    canvas { display: block; width: 100vw; height: 100vh; }
    
    #message {
      position: absolute;
      top: env(safe-area-inset-top, 10px);
      left: 0; right: 0;
      text-align: center;
      font-size: 0.9rem;
      color: #bfbfbf;
      transition: opacity .5s ease;
      pointer-events: none;
    }
    
    #controls {
      position: absolute;
      bottom: calc(env(safe-area-inset-bottom, 0px) + 10px);
      display: flex;
      gap: 10px;
    }
    #controls button{
      background:#222; color:#ddd; border:1px solid #333;
      padding:8px 14px; border-radius:8px; font-size:.95rem;
    }
    
    /* Hide controls in landscape for kiosk look */
    @media (orientation: landscape) and (max-height: 540px) {
      #controls { display: none; }
      #hamburger-menu { display: none; }
    }
    @media (orientation: landscape) and (min-height: 541px) {
      #controls { display: none; }
    }
    
    /* Hamburger Menu Styles */
    .hamburger {
      position: fixed;
      top: env(safe-area-inset-top, 20px);
      right: 20px;
      width: 30px;
      height: 30px;
      cursor: pointer;
      z-index: 1000;
      padding: 5px;
    }
    
    .hamburger-lines span {
      display: block;
      height: 3px;
      width: 100%;
      background: #ddd;
      margin: 5px 0;
      transition: 0.3s;
      border-radius: 2px;
    }
    
    .hamburger.active .hamburger-lines span:nth-child(1) {
      transform: rotate(45deg) translate(8px, 8px);
    }
    
    .hamburger.active .hamburger-lines span:nth-child(2) {
      opacity: 0;
    }
    
    .hamburger.active .hamburger-lines span:nth-child(3) {
      transform: rotate(-45deg) translate(8px, -8px);
    }
    
    /* Settings Panel Styles */
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 998;
    }
    
    .settings-panel {
      position: fixed;
      top: 0;
      right: 0;
      width: min(400px, 90vw);
      height: 100vh;
      background: #1a1a1a;
      color: #ddd;
      z-index: 999;
      transform: translateX(100%);
      transition: transform 0.3s ease;
      overflow-y: auto;
      border-left: 1px solid #333;
    }
    
    .settings-panel.visible {
      transform: translateX(0);
    }
    
    .hidden {
      display: none;
    }
    
    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      border-bottom: 1px solid #333;
    }
    
    .panel-header h3 {
      margin: 0;
      font-size: 1.2rem;
    }
    
    .close-btn {
      background: none;
      border: none;
      color: #ddd;
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
    }
    
    .panel-content {
      padding: 20px;
    }
    
    .section {
      margin-bottom: 30px;
    }
    
    .section h4 {
      margin: 0 0 15px 0;
      font-size: 1rem;
      color: #fff;
    }
    
    .input-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }
    
    .input-group input, .input-group select, .input-group textarea {
      background: #333;
      border: 1px solid #555;
      color: #ddd;
      padding: 8px;
      border-radius: 4px;
      font-size: 0.9rem;
    }
    
    .input-group input[type="time"] {
      width: 120px;
    }
    
    .input-group input[type="number"] {
      width: 80px;
    }
    
    .input-group select {
      width: 180px;
    }
    
    .btn-primary, .btn-secondary {
      background: #333;
      border: 1px solid #555;
      color: #ddd;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background-color 0.2s;
    }
    
    .btn-primary:hover, .btn-secondary:hover {
      background: #444;
    }
    
    .btn-primary {
      background: #10b981;
      border-color: #10b981;
    }
    
    .btn-primary:hover {
      background: #0d9668;
    }
    
    .btn-danger {
      background: #dc2626;
      border-color: #dc2626;
      color: white;
    }
    
    .btn-danger:hover {
      background: #b91c1c;
    }
    
    #schedule-list {
      background: #2a2a2a;
      border: 1px solid #444;
      border-radius: 4px;
      padding: 15px;
      margin-bottom: 15px;
      min-height: 100px;
      max-height: 200px;
      overflow-y: auto;
    }
    
    .schedule-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #444;
    }
    
    .schedule-item:last-child {
      border-bottom: none;
    }
    
    .schedule-time {
      font-weight: bold;
      color: #10b981;
    }
    
    .schedule-mode {
      font-size: 0.8rem;
      color: #999;
    }
    
    .delete-segment {
      background: #dc2626;
      border: none;
      color: white;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 0.8rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .url-display textarea {
      width: 100%;
      height: 80px;
      background: #2a2a2a;
      border: 1px solid #444;
      color: #ddd;
      padding: 10px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 0.8rem;
      resize: vertical;
      margin-bottom: 10px;
    }
    
    .preset-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 15px;
    }
    
    .preset-btn {
      background: #2a2a2a;
      border: 1px solid #555;
      color: #ddd;
      padding: 6px 12px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 0.8rem;
      transition: all 0.2s;
    }
    
    .preset-btn:hover {
      background: #10b981;
      border-color: #10b981;
    }
  </style>
</head>
<body>
  <canvas id="clock"></canvas>
  <div id="controls">
    <button id="startBtn">Start</button>
    <button id="stopBtn">Stop</button>
  </div>
  <div id="message">Loading...</div>
  
  <!-- Hamburger Menu -->
  <div id="hamburger-menu" class="hamburger">
    <div class="hamburger-lines">
      <span></span>
      <span></span>
      <span></span>
    </div>
  </div>
  
  <!-- Settings Panel -->
  <div id="settings-panel" class="settings-panel hidden">
    <div class="panel-header">
      <h3>Session Timer v2.0</h3>
      <button id="close-panel" class="close-btn">×</button>
    </div>
    
    <div class="panel-content">
      <div class="section">
        <h4>Timer Controls</h4>
        <div class="input-group">
          <button id="panel-start-btn" class="btn-primary">Start</button>
          <button id="panel-stop-btn" class="btn-secondary">Stop</button>
        </div>
      </div>
      
      <div class="section">
        <h4>Quick Presets</h4>
        <div class="preset-buttons">
          <button class="preset-btn" data-preset="focus30">30min Focus</button>
          <button class="preset-btn" data-preset="focus45">45min Focus</button>
          <button class="preset-btn" data-preset="focus60">60min Focus</button>
          <button class="preset-btn" data-preset="pomodoro">Pomodoro</button>
          <button class="preset-btn" data-preset="break5">5min Break</button>
          <button class="preset-btn" data-preset="break15">15min Break</button>
        </div>
      </div>
      
      <div class="section">
        <h4>Current Schedule</h4>
        <div id="schedule-list">No segments configured</div>
        <button id="clear-schedule" class="btn-secondary">Clear All</button>
      </div>
      
      <div class="section">
        <h4>Add Segment</h4>
        <div class="input-group">
          <input type="time" id="segment-time" placeholder="HH:MM">
          <input type="number" id="segment-duration" placeholder="Minutes" min="1" max="480">
          <select id="segment-mode">
            <option value="down">Count Down (End Time)</option>
            <option value="up">Count Up (Start Time)</option>
          </select>
          <button id="add-segment" class="btn-primary">Add</button>
        </div>
      </div>
      
      <div class="section">
        <h4>Export to Calendar</h4>
        <div class="input-group">
          <button id="export-ics" class="btn-secondary">Download ICS</button>
          <button id="copy-ics" class="btn-secondary">Copy ICS</button>
          <button id="fantastical-export" class="btn-primary">Open in Fantastical</button>
        </div>
        <textarea id="calendar-preview" readonly placeholder="Configure segments to see calendar preview" style="margin-top: 10px; height: 60px;"></textarea>
      </div>
      
      <div class="section">
        <h4>URL Configuration</h4>
        <div class="url-display">
          <textarea id="current-url" readonly placeholder="Configure segments above to generate URLs"></textarea>
          <div class="input-group">
            <button id="copy-url" class="btn-secondary">Copy Web URL</button>
            <button id="copy-custom-url" class="btn-primary">Copy sessiontimer://</button>
            <button id="floating-window" class="btn-secondary">Open Floating Window</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Overlay -->
  <div id="settings-overlay" class="overlay hidden"></div>

  <script type="module">
    // Import our modular components
    import { EventBus } from './src/eventBus.js';
    import { TimerCore } from './src/coreTimer.js';
    import { URLParser } from './src/urlParser.js';
    import { CalendarExport } from './src/calendarExport.js';
    
    // Initialize the application
    class SessionTimerApp {
      constructor() {
        this.eventBus = new EventBus();
        this.canvas = document.getElementById('clock');
        this.timer = new TimerCore(this.canvas, this.eventBus);
        this.urlParser = new URLParser(this.eventBus);
        this.calendarExport = new CalendarExport(this.eventBus);
        
        this.settings = null;
        this.autoStartInterval = null;
        
        this.initializeElements();
        this.bindEvents();
        this.loadConfiguration();
        this.startAutoStartCheck();
        
        // Register service worker for PWA
        this.registerServiceWorker();
      }
      
      initializeElements() {
        // Get DOM elements
        this.elements = {
          message: document.getElementById('message'),
          startBtn: document.getElementById('startBtn'),
          stopBtn: document.getElementById('stopBtn'),
          hamburgerMenu: document.getElementById('hamburger-menu'),
          settingsPanel: document.getElementById('settings-panel'),
          settingsOverlay: document.getElementById('settings-overlay'),
          closePanel: document.getElementById('close-panel'),
          scheduleList: document.getElementById('schedule-list'),
          clearScheduleBtn: document.getElementById('clear-schedule'),
          addSegmentBtn: document.getElementById('add-segment'),
          segmentTime: document.getElementById('segment-time'),
          segmentDuration: document.getElementById('segment-duration'),
          segmentMode: document.getElementById('segment-mode'),
          currentUrl: document.getElementById('current-url'),
          copyUrlBtn: document.getElementById('copy-url'),
          copyCustomUrlBtn: document.getElementById('copy-custom-url'),
          floatingWindowBtn: document.getElementById('floating-window'),
          panelStartBtn: document.getElementById('panel-start-btn'),
          panelStopBtn: document.getElementById('panel-stop-btn'),
          exportIcsBtn: document.getElementById('export-ics'),
          copyIcsBtn: document.getElementById('copy-ics'),
          fantasticalExportBtn: document.getElementById('fantastical-export'),
          calendarPreview: document.getElementById('calendar-preview')
        };
      }
      
      bindEvents() {
        // Timer controls
        this.elements.startBtn.addEventListener('click', () => this.eventBus.emit('timer:start', true));
        this.elements.stopBtn.addEventListener('click', () => this.eventBus.emit('timer:stop'));
        this.elements.panelStartBtn.addEventListener('click', () => this.eventBus.emit('timer:start', true));
        this.elements.panelStopBtn.addEventListener('click', () => this.eventBus.emit('timer:stop'));
        
        // Settings panel
        this.elements.hamburgerMenu.addEventListener('click', () => this.openSettingsPanel());
        this.elements.closePanel.addEventListener('click', () => this.closeSettingsPanel());
        this.elements.settingsOverlay.addEventListener('click', () => this.closeSettingsPanel());
        
        // Segment management
        this.elements.addSegmentBtn.addEventListener('click', () => this.addSegment());
        this.elements.clearScheduleBtn.addEventListener('click', () => this.clearAllSegments());
        
        // URL management
        this.elements.copyUrlBtn.addEventListener('click', () => this.copyUrl('web'));
        this.elements.copyCustomUrlBtn.addEventListener('click', () => this.copyUrl('custom'));
        this.elements.floatingWindowBtn.addEventListener('click', () => this.openFloatingWindow());
        
        // Calendar export
        this.elements.exportIcsBtn.addEventListener('click', () => this.exportCalendar('download'));
        this.elements.copyIcsBtn.addEventListener('click', () => this.exportCalendar('copy'));
        this.elements.fantasticalExportBtn.addEventListener('click', () => this.exportCalendar('fantastical'));
        
        // Preset buttons
        document.querySelectorAll('.preset-btn').forEach(btn => {
          btn.addEventListener('click', () => this.applyPreset(btn.dataset.preset));
        });
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (event) => this.handleKeyboard(event));
        
        // Event bus listeners
        this.eventBus.on('timer:started', (data) => this.showMessage(`${data.manual ? 'Manual' : 'Auto'} start ${data.time}`));
        this.eventBus.on('timer:stopped', () => this.showMessage('Stopped'));
        this.eventBus.on('segments:updated', () => this.updateUI());
        this.eventBus.on('calendar:downloaded', (data) => this.showMessage(`Calendar downloaded: ${data.filename}`));
        this.eventBus.on('calendar:copied', () => this.showMessage('Calendar copied to clipboard'));
        this.eventBus.on('popup:opened', () => this.showMessage('Floating window opened'));
        this.eventBus.on('popup:blocked', () => this.showMessage('Popup blocked - please allow popups for this site'));
      }
      
      async loadConfiguration() {
        this.showMessage('Loading configuration...');
        
        // Try URL parameters first
        const urlConfig = this.urlParser.parseUrlParameters();
        if (urlConfig) {
          if (urlConfig.segments) {
            this.urlParser.setSegments(urlConfig.segments);
          } else {
            this.timer.configure(urlConfig);
          }
          this.showMessage('Loaded from URL parameters');
          this.timer.startAnimation();
          return;
        }
        
        // Fallback to settings.json
        try {
          const response = await fetch('settings.json', { cache: 'no-cache' });
          this.settings = await response.json();
          
          this.timer.configure({
            segmentDuration: this.settings.segmentDuration || 2400,
            autoStart: this.settings.autoStart
          });
          
          this.showMessage('Settings loaded from JSON');
        } catch (error) {
          this.showMessage('Using default settings');
          console.error('Failed to load settings:', error);
        }
        
        this.timer.startAnimation();
      }
      
      startAutoStartCheck() {
        this.autoStartInterval = setInterval(() => {
          if (this.settings) {
            this.timer.checkAutoStart(this.settings);
          }
        }, 1000);
      }
      
      async registerServiceWorker() {
        if ('serviceWorker' in navigator) {
          try {
            await navigator.serviceWorker.register('./sw.js');
            console.log('Service Worker registered');
          } catch (error) {
            console.error('Service Worker registration failed:', error);
          }
        }
      }
      
      showMessage(text, hideAfterMs = 2200) {
        this.elements.message.textContent = text;
        this.elements.message.style.opacity = 1;
        if (hideAfterMs) {
          setTimeout(() => { this.elements.message.style.opacity = 0; }, hideAfterMs);
        }
      }
      
      openSettingsPanel() {
        this.elements.settingsPanel.classList.remove('hidden');
        this.elements.settingsOverlay.classList.remove('hidden');
        this.elements.hamburgerMenu.classList.add('active');
        setTimeout(() => {
          this.elements.settingsPanel.classList.add('visible');
        }, 10);
        this.updateUI();
      }
      
      closeSettingsPanel() {
        this.elements.settingsPanel.classList.remove('visible');
        this.elements.hamburgerMenu.classList.remove('active');
        setTimeout(() => {
          this.elements.settingsPanel.classList.add('hidden');
          this.elements.settingsOverlay.classList.add('hidden');
        }, 300);
      }
      
      addSegment() {
        const time = this.elements.segmentTime.value;
        const duration = parseInt(this.elements.segmentDuration.value);
        const mode = this.elements.segmentMode.value;
        
        if (!time || !duration) {
          this.showMessage('Please fill in time and duration');
          return;
        }
        
        const segment = { time, duration, mode };
        this.urlParser.addSegment(segment);
        
        // Clear inputs
        this.elements.segmentTime.value = '';
        this.elements.segmentDuration.value = '';
        
        this.showMessage(`Segment added: ${time} (${duration}min)`);
      }
      
      clearAllSegments() {
        this.urlParser.clearSegments();
        this.showMessage('All segments cleared');
      }
      
      applyPreset(preset) {
        const now = new Date();
        const currentTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
        
        const presets = {
          focus30: [{ time: currentTime, duration: 30, mode: 'down' }],
          focus45: [{ time: currentTime, duration: 45, mode: 'down' }],
          focus60: [{ time: currentTime, duration: 60, mode: 'down' }],
          pomodoro: [
            { time: currentTime, duration: 25, mode: 'down' },
            { time: this.addMinutes(currentTime, 25), duration: 5, mode: 'up' }
          ],
          break5: [{ time: currentTime, duration: 5, mode: 'up' }],
          break15: [{ time: currentTime, duration: 15, mode: 'up' }]
        };
        
        if (presets[preset]) {
          this.urlParser.setSegments(presets[preset]);
          this.showMessage(`Applied ${preset} preset`);
        }
      }
      
      addMinutes(timeStr, minutes) {
        const [hours, mins] = timeStr.split(':').map(Number);
        const date = new Date();
        date.setHours(hours, mins + minutes, 0, 0);
        return `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
      }
      
      updateUI() {
        this.updateScheduleDisplay();
        this.updateUrlDisplay();
        this.updateCalendarPreview();
      }
      
      updateScheduleDisplay() {
        const segments = this.urlParser.getSegments();
        
        if (segments.length === 0) {
          this.elements.scheduleList.innerHTML = 'No segments configured';
          return;
        }
        
        this.elements.scheduleList.innerHTML = segments.map((segment, index) => `
          <div class="schedule-item">
            <div>
              <div class="schedule-time">${segment.time}</div>
              <div class="schedule-mode">${segment.duration}min (${segment.mode === 'up' ? 'Count Up - Start Time' : 'Count Down - End Time'})</div>
            </div>
            <button class="delete-segment" onclick="app.deleteSegment(${index})">×</button>
          </div>
        `).join('');
      }
      
      deleteSegment(index) {
        this.urlParser.removeSegment(index);
        this.showMessage('Segment deleted');
      }
      
      updateUrlDisplay() {
        const segments = this.urlParser.getSegments();
        const urls = this.urlParser.generateUrls(segments);
        
        if (typeof urls.webUrl === 'string' && !urls.webUrl.startsWith('http')) {
          this.elements.currentUrl.value = urls.webUrl;
        } else {
          this.elements.currentUrl.value = urls.webUrl;
        }
      }
      
      updateCalendarPreview() {
        const segments = this.urlParser.getSegments();
        const preview = this.calendarExport.generatePreview(segments);
        this.elements.calendarPreview.value = preview;
      }
      
      async copyUrl(type) {
        const segments = this.urlParser.getSegments();
        const urls = this.urlParser.generateUrls(segments);
        
        const url = type === 'custom' ? urls.customScheme : urls.webUrl;
        
        try {
          await navigator.clipboard.writeText(url);
          this.showMessage(`${type === 'custom' ? 'Custom scheme' : 'Web'} URL copied!`);
        } catch (err) {
          // Fallback
          this.elements.currentUrl.select();
          document.execCommand('copy');
          this.showMessage('URL copied!');
        }
      }
      
      openFloatingWindow() {
        const segments = this.urlParser.getSegments();
        const urls = this.urlParser.generateUrls(segments);
        this.urlParser.openFloatingWindow(urls.floatingWindow);
      }
      
      async exportCalendar(type) {
        const segments = this.urlParser.getSegments();
        
        if (segments.length === 0) {
          this.showMessage('No segments to export');
          return;
        }
        
        switch (type) {
          case 'download':
            this.calendarExport.downloadICS(segments);
            break;
          case 'copy':
            await this.calendarExport.copyICSToClipboard(segments);
            break;
          case 'fantastical':
            this.calendarExport.openInFantastical(segments);
            break;
        }
      }
      
      handleKeyboard(event) {
        if (event.code === 'Space') {
          event.preventDefault();
          if (this.timer.isRunning) {
            this.eventBus.emit('timer:stop');
          } else {
            this.eventBus.emit('timer:start', true);
          }
        }
        
        if (event.code === 'Escape') {
          if (!this.elements.settingsPanel.classList.contains('hidden')) {
            this.closeSettingsPanel();
          }
        }
      }
    }
    
    // Initialize the application
    window.app = new SessionTimerApp();
  </script>
</body>
</html>
