<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Session Timer</title>
  <style>
    body {
      margin: 0;
      background: black;
      color: white;
      font-family: -apple-system, sans-serif;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    canvas {
      display: block;
    }
    #controls {
      margin-top: 10px;
    }
    button {
      font-size: 1.2em;
      padding: 0.4em 1em;
      margin: 0.2em;
      border-radius: 8px;
      border: none;
      cursor: pointer;
    }
    #message {
      margin-top: 10px;
      font-size: 1em;
      color: #FDDA0D;
    }
  </style>
</head>
<body>
  <canvas id="clock" width="500" height="500"></canvas>
  <div id="controls">
    <button id="startBtn">Start</button>
    <button id="stopBtn">Stop</button>
  </div>
  <div id="message"></div>

  <script>
    const canvas = document.getElementById('clock');
    const ctx = canvas.getContext('2d');
    const r = canvas.width / 2;
    const cx = r, cy = r;

    let timerActive = false;
    let timerStart = null;
    let timerDuration = null;

    // ========= CLOCK DRAWING =========
    function drawClock() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      const now = new Date();
      const ms = now.getMilliseconds();
      const s = now.getSeconds() + ms/1000;
      const m = now.getMinutes() + s/60;
      const h = now.getHours() % 12 + m/60;

      // Face outline
      ctx.beginPath();
      ctx.arc(cx, cy, r-5, 0, Math.PI*2);
      ctx.strokeStyle = '#444';
      ctx.lineWidth = 4;
      ctx.stroke();

      // Timer arc (if active)
      if (timerActive && timerDuration) {
        const elapsed = (Date.now() - timerStart) / 1000;
        const progress = Math.min(elapsed / timerDuration, 1);

        // arc start = current minute hand position
        const startAngle = m * (Math.PI/30) - Math.PI/2;
        const endAngle = startAngle + progress * (timerDuration/60) * (Math.PI/30);

        // background arc (grey track)
        ctx.beginPath();
        ctx.arc(cx, cy, r*0.9, startAngle, startAngle + (timerDuration/60)*(Math.PI/30));
        ctx.strokeStyle = '#333';
        ctx.lineWidth = 12;
        ctx.stroke();

        // foreground arc (elapsed)
        let col = '#0f0';
        if (elapsed > timerDuration - 600) col = '#ffa500'; // last 10 min
        if (elapsed > timerDuration - 300) col = '#f00';   // last 5 min

        ctx.beginPath();
        ctx.arc(cx, cy, r*0.9, startAngle, endAngle);
        ctx.strokeStyle = col;
        ctx.lineWidth = 12;
        ctx.stroke();

        if (progress >= 1) timerActive = false;
      }

      // Hour hand
      ctx.beginPath();
      ctx.moveTo(cx, cy);
      ctx.lineTo(cx + Math.cos(h * (Math.PI/6) - Math.PI/2) * (r*0.50),
                 cy + Math.sin(h * (Math.PI/6) - Math.PI/2) * (r*0.50));
      ctx.strokeStyle = '#e6e6e6';
      ctx.lineWidth = 20;
      ctx.lineCap = 'round';
      ctx.stroke();

      // Minute hand
      ctx.beginPath();
      ctx.moveTo(cx, cy);
      ctx.lineTo(cx + Math.cos(m * (Math.PI/30) - Math.PI/2) * (r*0.75),
                 cy + Math.sin(m * (Math.PI/30) - Math.PI/2) * (r*0.75));
      ctx.strokeStyle = '#ffffff';
      ctx.lineWidth = 10;
      ctx.lineCap = 'round';
      ctx.stroke();

      // Second hand (sweeping)
      ctx.beginPath();
      ctx.moveTo(cx, cy);
      ctx.lineTo(cx + Math.cos(s * (Math.PI/30) - Math.PI/2) * (r*0.86),
                 cy + Math.sin(s * (Math.PI/30) - Math.PI/2) * (r*0.86));
      ctx.strokeStyle = '#FDDA0D';
      ctx.lineWidth = 3;
      ctx.lineCap = 'round';
      ctx.stroke();

      // Center pivot
      ctx.beginPath();
      ctx.arc(cx, cy, 16, 0, Math.PI*2);
      ctx.fillStyle = '#FDDA0D';
      ctx.fill();

      requestAnimationFrame(drawClock);
    }

    // ========= TIMER CONTROL =========
    function startTimer(durationSeconds) {
      timerActive = true;
      timerStart = Date.now();
      timerDuration = durationSeconds;
      document.getElementById('message').textContent =
        "Timer started: " + Math.round(durationSeconds/60) + " minutes";
    }

    function stopTimer() {
      timerActive = false;
      document.getElementById('message').textContent = "Timer stopped";
    }

    document.getElementById('startBtn').addEventListener('click', () => {
      if (timerDuration) {
        startTimer(timerDuration); // restart with last duration
      }
    });
    document.getElementById('stopBtn').addEventListener('click', stopTimer);

    // ========= INITIALIZATION =========
    function parseURLScenario() {
      const params = new URLSearchParams(window.location.search);
      const s = params.get('s');
      if (!s) return;

      const [label, timeStr, durStr] = s.split(',');
      if (!timeStr || !durStr) return;

      const [hh, mm] = timeStr.split(':').map(Number);
      const duration = parseInt(durStr, 10);

      const now = new Date();
      const target = new Date();
      target.setHours(hh, mm, 0, 0);

      if (now >= target) {
        // already past start â†’ run immediately
        startTimer(duration);
      } else {
        // wait until start time
        document.getElementById('message').textContent =
          `Waiting until ${timeStr} to start ${Math.round(duration/60)} min timer`;
        setTimeout(() => startTimer(duration), target - now);
      }
    }

    // Example for scenario 1 (JSON)
    async function loadJSONScenario() {
      try {
        const res = await fetch("settings.json");
        const data = await res.json();
        // e.g., data.sessions[0].duration
        if (data.sessions && data.sessions.length > 0) {
          timerDuration = data.sessions[0].duration;
        }
      } catch(e) {
        console.log("No JSON scenario", e);
      }
    }

    // init
    loadJSONScenario();
    parseURLScenario();
    drawClock();
  </script>
</body>
</html>