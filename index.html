<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>40-Minute Cycling Timer</title>
<style>
    /* Full black background stretching to browser menu area */
    html, body {
        margin: 0;
        padding: 0;
        height: 100%;
        background: #000;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    /* Canvas fills viewport */
    canvas {
        display: block;
    }

    /* Start/Stop buttons */
    .controls {
        position: absolute;
        bottom: 20px;
        display: flex;
        gap: 20px;
    }

    button {
        padding: 10px 20px;
        font-size: 16px;
        border-radius: 12px;
        border: 1px solid rgba(255,255,255,0.5);
        background: rgba(255,255,255,0.1);
        color: white;
        cursor: pointer;
        backdrop-filter: blur(5px);
    }

    /* Landscape: hide buttons on mobile */
    @media (max-width: 1024px) and (orientation: landscape) {
        .controls {
            display: none;
        }
    }

    /* Settings notification */
    #settingsMsg {
        position: absolute;
        top: 20px;
        color: #aaa;
        font-size: 14px;
        text-align: center;
        width: 100%;
        pointer-events: none;
        user-select: none;
    }
</style>
</head>
<body>
<div id="settingsMsg">Loading settings...</div>
<canvas id="timerCanvas"></canvas>

<div class="controls">
    <button id="startBtn">Start</button>
    <button id="stopBtn">Stop</button>
</div>

<script>
const canvas = document.getElementById('timerCanvas');
const ctx = canvas.getContext('2d');

let width, height, r, cx, cy;
let elapsedSeconds = 0;
let segmentIndex = 0;
let isRunning = false;
let timerInterval;

let settings = {
    autoStart: "09:00",
    segmentDuration: 2400, // default 40 minutes
    segments: [
        { startTime: "09:00", duration: 2400, startAngle: -90 },
        { startTime: "09:40", duration: 2400, startAngle: 150 },
        { startTime: "10:20", duration: 2400, startAngle: 30 }
    ]
};

// Load settings.json from GitHub
fetch("https://raw.githubusercontent.com/piarasj/timer/517a5566a35abb8bf642716b24f5314dcbfcb068/settings.json")
.then(res => res.json())
.then(json => {
    settings = json;
    document.getElementById("settingsMsg").textContent = 
        `Settings loaded: autoStart ${settings.autoStart}, ${settings.segmentDuration/60}-minute segments`;
})
.catch(err => {
    document.getElementById("settingsMsg").textContent = "Failed to load settings, using defaults.";
});

// Resize canvas
function resizeCanvas() {
    width = window.innerWidth;
    height = window.innerHeight;
    canvas.width = width;
    canvas.height = height;
    r = Math.min(width, height) * 0.45;
    cx = width/2;
    cy = height/2;
}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

// Draw function
function drawClock() {
    ctx.clearRect(0,0,width,height);

    const segment = settings.segments[segmentIndex] || settings.segments[0];
    const startAngle = (segment.startAngle * Math.PI/180);
    const endAngle = startAngle + (segment.duration / 3600 * 2*Math.PI); // proportional to 360Â° for segmentDuration
    
    // --- Track (light grey arc) ---
    ctx.beginPath();
    ctx.arc(cx, cy, r, startAngle, endAngle);
    ctx.strokeStyle = "#555"; 
    ctx.lineWidth = 20;
    ctx.lineCap = "round";
    ctx.stroke();

    // --- Progress overlay arc (green->orange->red) ---
    const progressAngle = startAngle + (elapsedSeconds / segment.duration) * (endAngle - startAngle);
    let color = "#22c55e"; // green
    if (elapsedSeconds >= segment.duration - 600) color = "#f59e0b"; // last 10 min -> orange
    if (elapsedSeconds >= segment.duration - 300) color = "#ef4444"; // last 5 min -> red

    ctx.beginPath();
    ctx.arc(cx, cy, r, startAngle, progressAngle);
    ctx.strokeStyle = color;
    ctx.lineWidth = 20;
    ctx.lineCap = "round";
    ctx.stroke();

    // --- Centre dot ---
    ctx.beginPath();
    ctx.arc(cx, cy, 8, 0, 2*Math.PI);
    ctx.fillStyle = "white";
    ctx.fill();

    // --- Current time for hands ---
    const now = new Date();
    const hr = now.getHours()%12 + now.getMinutes()/60;
    const min = now.getMinutes() + now.getSeconds()/60;
    const sec = now.getSeconds() + now.getMilliseconds()/1000;

    const hrA = (hr/12)*2*Math.PI - Math.PI/2;
    const minA = (min/60)*2*Math.PI - Math.PI/2;
    const secA = (sec/60)*2*Math.PI - Math.PI/2;

    // --- Hour hand (shaft + cap) ---
    ctx.beginPath();
    ctx.moveTo(cx, cy);
    ctx.lineTo(cx + Math.cos(hrA)*r*0.5, cy + Math.sin(hrA)*r*0.5);
    ctx.strokeStyle = "white";
    ctx.lineWidth = 8;
    ctx.lineCap = "round";
    ctx.stroke();
    ctx.beginPath();
    ctx.arc(cx + Math.cos(hrA)*r*0.5, cy + Math.sin(hrA)*r*0.5, 6, 0, 2*Math.PI);
    ctx.fillStyle = "white";
    ctx.fill();

    // --- Minute hand (shaft + cap) ---
    ctx.beginPath();
    ctx.moveTo(cx, cy);
    ctx.lineTo(cx + Math.cos(minA)*r*0.75, cy + Math.sin(minA)*r*0.75);
    ctx.strokeStyle = "white";
    ctx.lineWidth = 5;
    ctx.lineCap = "round";
    ctx.stroke();
    ctx.beginPath();
    ctx.arc(cx + Math.cos(minA)*r*0.75, cy + Math.sin(minA)*r*0.75, 5, 0, 2*Math.PI);
    ctx.fillStyle = "white";
    ctx.fill();

    // --- Second hand (yellow) ---
    ctx.beginPath();
    ctx.moveTo(cx, cy);
    ctx.lineTo(cx + Math.cos(secA)*r*0.85, cy + Math.sin(secA)*r*0.85);
    ctx.strokeStyle = "#FDDA0D";
    ctx.lineWidth = 2;
    ctx.lineCap = "round";
    ctx.stroke();
    ctx.beginPath();
    ctx.arc(cx, cy, 5, 0, 2*Math.PI); // dot at origin
    ctx.fillStyle = "#FDDA0D";
    ctx.fill();
}

// Timer update
function updateTimer() {
    if (isRunning) {
        elapsedSeconds++;
        const segment = settings.segments[segmentIndex];
        if (elapsedSeconds >= segment.duration) {
            elapsedSeconds = 0;
            segmentIndex = (segmentIndex + 1) % settings.segments.length;
        }
    }
    drawClock();
    requestAnimationFrame(updateTimer);
}

// Start/Stop buttons
document.getElementById("startBtn").addEventListener("click", () => {
    isRunning = true;
    elapsedSeconds = 0;
    document.getElementById("settingsMsg").style.display = "none";
});
document.getElementById("stopBtn").addEventListener("click", () => {
    isRunning = false;
});

// Auto-start at settings.autoStart
setInterval(() => {
    const now = new Date();
    const [h,m] = settings.autoStart.split(":").map(Number);
    if (now.getHours()===h && now.getMinutes()===m && !isRunning) {
        isRunning = true;
        elapsedSeconds = 0;
        document.getElementById("settingsMsg").style.display = "none";
    }
}, 1000);

// Start animation loop
updateTimer();
</script>
</body>
</html>