<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>40-Minute Cycling Timer</title>
<style>
  html, body {
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100%;
    background: black;
    overflow: hidden;
    font-family: -apple-system, sans-serif;
    color: lightgray;
  }
  canvas {
    display: block;
    width: 100vw;
    height: 100vh;
  }
  #controls {
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 10px;
  }
  button {
    padding: 10px 20px;
    font-size: 16px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
  }
  #startBtn { background: green; color: white; }
  #stopBtn { background: red; color: white; }
  #status {
    position: absolute;
    top: 10px;
    left: 50%;
    transform: translateX(-50%);
    color: lightgray;
    font-size: 16px;
    text-align: center;
  }
  @media screen and (orientation: landscape) {
    #controls { display: none; }
  }
</style>
</head>
<body>

<div id="status">Loading settings...</div>
<canvas id="clockCanvas"></canvas>

<div id="controls">
  <button id="startBtn">Start</button>
  <button id="stopBtn">Stop</button>
</div>

<script>
const canvas = document.getElementById("clockCanvas");
const ctx = canvas.getContext("2d");

let running = false;
let startTime = null;
let segmentDuration = 40 * 60 * 1000; // default 40 minutes
let segmentEndTime = null;

// Load settings.json
async function loadSettings() {
  try {
    const response = await fetch("settings.json");
    const settings = await response.json();

    if (settings.segmentDuration) {
      segmentDuration = settings.segmentDuration * 60 * 1000;
    }

    const statusEl = document.getElementById("status");
    const autoStartText = settings.autoStartTime ? `auto-start at ${settings.autoStartTime}` : "manual start";
    statusEl.textContent = `Settings loaded: ${autoStartText}, ${settings.segmentDuration}-minute segments`;

    // Auto-start if current time matches settings
    if (settings.autoStartTime) {
      const [autoHour, autoMinute] = settings.autoStartTime.split(":").map(Number);
      const now = new Date();
      if (now.getHours() === autoHour && now.getMinutes() === autoMinute) {
        startSegment();
      }
    }

  } catch(e) {
    console.error("Error loading settings.json", e);
    document.getElementById("status").textContent = "Error loading settings.json";
  }
}

function startSegment() {
  running = true;
  startTime = new Date();
  segmentEndTime = new Date(startTime.getTime() + segmentDuration);
}

function stopSegment() {
  running = false;
}

function checkSegment() {
  if (running && new Date() >= segmentEndTime) {
    startSegment(); // start next segment automatically
  }
}

function drawClock() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  const radius = Math.min(canvas.width, canvas.height) / 2 * 0.9;
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.save();
  ctx.translate(canvas.width / 2, canvas.height / 2);

  const now = new Date();
  const hour = now.getHours();
  const minute = now.getMinutes();
  const second = now.getSeconds();

  // Base track (dark gray)
  ctx.beginPath();
  ctx.arc(0, 0, radius, 0, 2 * Math.PI);
  ctx.lineWidth = 40; // doubled width for visibility
  ctx.strokeStyle = "#222";
  ctx.stroke();

  // Progress arc following minute hand
  if (running) {
    const elapsed = now - startTime;
    const progress = Math.min(elapsed / segmentDuration, 1);
    const startAngle = -Math.PI/2 + (minute*6 + second*0.1) * Math.PI/180;
    const endAngle = startAngle + progress * 2 * Math.PI;

    ctx.beginPath();
    ctx.arc(0, 0, radius, startAngle, endAngle);
    ctx.lineWidth = 40;
    ctx.strokeStyle = "limegreen";
    ctx.stroke();
  }

  // Hour hand
  const hourAngle = ((hour%12) + minute/60) * 30 * Math.PI/180 - Math.PI/2;
  ctx.beginPath();
  ctx.moveTo(0,0);
  ctx.lineTo(Math.cos(hourAngle)*radius*0.5, Math.sin(hourAngle)*radius*0.5);
  ctx.lineWidth = 8;
  ctx.strokeStyle = "lightgray";
  ctx.stroke();

  // Minute hand
  const minuteAngle = (minute + second/60) * 6 * Math.PI/180 - Math.PI/2;
  ctx.beginPath();
  ctx.moveTo(0,0);
  ctx.lineTo(Math.cos(minuteAngle)*radius*0.75, Math.sin(minuteAngle)*radius*0.75);
  ctx.lineWidth = 6;
  ctx.strokeStyle = "lightgray";
  ctx.stroke();

  // Second hand (Cadmium Yellow)
  const secondAngle = second * 6 * Math.PI/180 - Math.PI/2;
  ctx.beginPath();
  ctx.moveTo(0,0);
  ctx.lineTo(Math.cos(secondAngle)*radius*0.85, Math.sin(secondAngle)*radius*0.85);
  ctx.lineWidth = 2;
  ctx.strokeStyle = "#FDDA0D";
  ctx.stroke();

  ctx.restore();
  checkSegment();
  requestAnimationFrame(drawClock);
}

document.getElementById("startBtn").addEventListener("click", startSegment);
document.getElementById("stopBtn").addEventListener("click", stopSegment);

loadSettings().then(drawClock);
</script>
</body>
</html>