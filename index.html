<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Track Segment Timer</title>
<style>
  body {
    margin: 0;
    background: black;
    color: white;
    font-family: -apple-system, sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100vh;
    overflow: hidden;
  }
  .clock {
    position: relative;
    width: 90vmin;
    height: 90vmin;
    max-width: 90vh;
    max-height: 90vw;
    border-radius: 50%;
    background: black;
  }
  .hand {
    position: absolute;
    bottom: 50%;
    left: 50%;
    transform-origin: bottom center;
    background: white;
  }
  .hour { width: 6px; height: 25%; color: white;}
  .minute { width: 4px; height: 40%; }
  canvas {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
  }
  .hour-mark {
    position: absolute;
    width: 4px;
    height: 20px;
    background: white;
    top: 10px;
    left: 50%;
    transform-origin: 50% 130px;
    margin-left: -2px;
    }
  
  .controls {
    margin-top: 20px;
  }
  button {
    padding: 10px 20px;
    font-size: 1.2rem;
    margin: 0 5px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
  }
  .status {
    margin-top: 10px;
    font-size: 1.1rem;
  }
</style>
</head>
<body>
  <div class="clock" id="clock">
    <canvas id="arcCanvas"></canvas>
    <div class="hand hour" id="hourHand"></div>
    <div class="hand minute" id="minuteHand"></div>
  </div>
  <div class="controls">
    <button id="startBtn" style="background:#22c55e;color:white;">Start</button>
    <button id="stopBtn" style="background:#ef4444;color:white;">Stop</button>
  </div>
  <div class="status" id="status">Loading settings…</div>

<script>
let autoStartTime = null;
let segmentDuration = 40; // minutes (default)
let startTime = null;
let timer = null;
let startMinuteAngle = 0;

const hourHand = document.getElementById('hourHand');
const minuteHand = document.getElementById('minuteHand');
const statusEl = document.getElementById('status');
const arcCanvas = document.getElementById('arcCanvas');
const ctx = arcCanvas.getContext('2d');

// scale canvas
function resizeCanvas() {
  arcCanvas.width = arcCanvas.clientWidth * window.devicePixelRatio;
  arcCanvas.height = arcCanvas.clientHeight * window.devicePixelRatio;
  ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
}
resizeCanvas();
window.addEventListener('resize', resizeCanvas);

// Load settings.json
fetch("settings.json")
  .then(r => r.json())
  .then(data => {
    autoStartTime = data.autoStart;
    segmentDuration = parseInt(data.segmentDuration) || 40;
    statusEl.textContent = `Autostart at ${autoStartTime}, ${segmentDuration} min track`;
  })
  .catch(() => {
    statusEl.textContent = "Using defaults: no settings.json found";
  });

function updateClock() {
  const now = new Date();
  const hr = now.getHours() % 12;
  const min = now.getMinutes();
  const sec = now.getSeconds();
  const hourDeg = (hr + min / 60) * 30;
  const minuteDeg = (min + sec / 60) * 6;
  hourHand.style.transform = `translate(-50%, 0) rotate(${hourDeg}deg)`;
  minuteHand.style.transform = `translate(-50%, 0) rotate(${minuteDeg}deg)`;

  if (startTime) updateArc();
}

function startSegment() {
  startTime = new Date();
  startMinuteAngle = startTime.getMinutes() * 6 - 90; // -90° to align with canvas 0° at 3 o'clock
  statusEl.textContent = `Started at ${startTime.toTimeString().slice(0,5)}`;
  if (!timer) timer = setInterval(updateClock, 1000);
}

function stopSegment() {
  startTime = null;
  drawArc(0);
  statusEl.textContent = "Stopped";
}

function updateArc() {
  const now = new Date();
  const elapsedMs = now - startTime;
  const elapsedMin = elapsedMs / 60000;
  const fraction = Math.min(elapsedMin / segmentDuration, 1);
  drawArc(fraction);
}

function drawArc(fraction) {
  const w = arcCanvas.clientWidth;
  const h = arcCanvas.clientHeight;
  ctx.clearRect(0, 0, w, h);

  const cx = w / 2;
  const cy = h / 2;
  const radius = w / 2 - 10;
  const startAngle = (startMinuteAngle * Math.PI) / 180;
  const totalAngle = (segmentDuration * 6 * Math.PI) / 180;
  const progressAngle = totalAngle * fraction;

  // background slice
  ctx.beginPath();
  ctx.arc(cx, cy, radius, startAngle, startAngle + totalAngle);
  ctx.strokeStyle = "#444";
  ctx.lineWidth = 30; // track width
  ctx.stroke();

  // progress slice
  let color = (fraction <= 0.5) ? '#22c55e' : (fraction <= 0.8 ? '#f59e0b' : '#ef4444');
  ctx.beginPath();
  ctx.arc(cx, cy, radius, startAngle, startAngle + progressAngle);
  ctx.strokeStyle = color;
  ctx.lineWidth = 30; // track width
  ctx.stroke();
}

document.getElementById('startBtn').addEventListener('click', startSegment);
document.getElementById('stopBtn').addEventListener('click', stopSegment);

// tick
setInterval(updateClock, 1000);
</script>
</body>
</html>