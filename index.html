<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Segment Timer Clock</title>
<style>
body {
  margin:0;
  background:black;
  color:white;
  font-family:-apple-system, sans-serif;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  min-height:100dvh;
  text-align:center;
}
canvas { display:block; }
#controls { margin-top:1rem; }
button {
  margin:0 .5rem;
  padding:.5rem 1rem;
  border:none;
  border-radius:.5rem;
  background:#22c55e;
  color:white;
  font-size:1rem;
  cursor:pointer;
}
button.stop { background:#ef4444; }
#ack { margin-top:1rem; font-size:1.1rem; }
</style>
</head>
<body>
<canvas id="clock" width="320" height="320"></canvas>
<div id="controls">
  <button id="startBtn">Start</button>
  <button id="stopBtn" class="stop">Stop</button>
</div>
<div id="ack"></div>

<script>
let settings, timer, running=false;

async function loadSettings() {
  try {
    const res = await fetch("settings.json");
    settings = await res.json();
  } catch(e) {
    console.error("Could not load settings.json", e);
    settings = {
      autoStart:"09:00",
      segments:[{start:"09:00",duration:40}]
    };
  }
  drawClock(new Date());
}

function parseTime(t){
  const [h,m] = t.split(":").map(Number);
  const d = new Date();
  d.setHours(h,m,0,0);
  return d;
}

function drawClock(now){
  const canvas = document.getElementById("clock");
  const ctx = canvas.getContext("2d");
  const r = canvas.width/2;

  ctx.clearRect(0,0,canvas.width,canvas.height);

  // clock face
  ctx.beginPath();
  ctx.arc(r,r,r-2,0,2*Math.PI);
  ctx.strokeStyle="white";
  ctx.lineWidth=2;
  ctx.stroke();

  // segments
  if(settings?.segments){
    settings.segments.forEach(seg=>{
      const start = parseTime(seg.start);
      const durMs = seg.duration * 60 * 1000;
      const end = new Date(start.getTime()+durMs);

      // light gray reference arc (full segment)
      const startAng = -Math.PI/2; // start at top
      const fullArc = (seg.duration/60)*2*Math.PI; // fraction of circle
      ctx.beginPath();
      ctx.arc(r,r,r-12,startAng,startAng+fullArc,false);
      ctx.lineWidth=14;
      ctx.strokeStyle="rgba(255,255,255,.8)";
      ctx.stroke();

      // dynamic arc for current segment
      if(now>=start && now<=end){
        const elapsed = now-start;
        const percentage = elapsed/durMs;
        let color;
        if(percentage<=0.5) color="#22c55e";       // green
        else if(percentage<=0.8) color="#f59e0b"; // yellow
        else color="#ef4444";                      // red

        const dynamicEnd = startAng + fullArc*percentage;
        ctx.beginPath();
        ctx.arc(r,r,r-12,startAng,dynamicEnd,false);
        ctx.lineWidth=14;
        ctx.strokeStyle=color;
        ctx.stroke();
      }
    });
  }

  // hour hand
  const hour = now.getHours()%12;
  const minute = now.getMinutes();
  const hourAng = ((hour+minute/60)/12)*2*Math.PI - Math.PI/2;
  ctx.beginPath();
  ctx.moveTo(r,r);
  ctx.lineTo(r + Math.cos(hourAng)*r*0.5, r + Math.sin(hourAng)*r*0.5);
  ctx.lineWidth=4;
  ctx.strokeStyle="white";
  ctx.stroke();

  // minute hand
  const minuteAng = (minute/60)*2*Math.PI - Math.PI/2;
  ctx.beginPath();
  ctx.moveTo(r,r);
  ctx.lineTo(r + Math.cos(minuteAng)*r*0.75, r + Math.sin(minuteAng)*r*0.75);
  ctx.lineWidth=2;
  ctx.strokeStyle="white";
  ctx.stroke();
}

// start/stop
function startTimer(){
  if(running) return;
  running=true;

  const now = new Date();
  const hh = now.getHours().toString().padStart(2,'0');
  const mm = now.getMinutes().toString().padStart(2,'0');

  document.getElementById("ack").textContent="Started at "+hh+":"+mm;

  // set first segment start to now
  if(settings.segments.length > 0){
    settings.segments[0].start = hh+":"+mm;
  }

  timer=setInterval(()=>drawClock(new Date()),1000);
}

function stopTimer(){
  running=false;
  clearInterval(timer);
  document.getElementById("ack").textContent="Stopped.";
}

document.getElementById("startBtn").addEventListener("click",startTimer);
document.getElementById("stopBtn").addEventListener("click",stopTimer);

loadSettings();
</script>
</body>
</html>